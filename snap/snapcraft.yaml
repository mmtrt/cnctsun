name: cnctsun
title: C&C Tiberian Sun (WINE)
version: '1.0'
summary: C&C Tiberian Sun is a real-time strategy game.
description: |
 C&C Tiberian Sun is a real-time strategy video game developed by Westwood Studios and released in 1999. The main storyline follows the second major war between the Global Defense Initiative (GDI) of the United Nations, and the global terrorist organization known as the Brotherhood of Nod. The story takes place 30 years after the GDI had won the First Tiberium War in Command & Conquer.

grade: stable
confinement: strict
architectures:
  - build-on: amd64
    run-on: [amd64, i386]
base: core18
compression: lzo

plugs:
  wine-runtime:
    interface: content
    target: $SNAP/wine-runtime
    default-provider: wine-platform-runtime
  wine-5-stable:
    interface: content
    target: $SNAP/wine-platform
    default-provider: wine-platform-5-stable

environment:
  WINEDLLOVERRIDES: "mshtml="    # Prevent pop-ups about Wine Gecko
  WINEPREFIX: "$SNAP_USER_COMMON/.wine"
  WINEARCH: "win32"
  INSTALL_URL_TS: "https://tore29.com/tsins/TSinstaller.exe" # cnctsun full game setup
  INSTALL_URL_CNC: "https://downloads.cncnet.org/TiberianSun_Online_Installer.exe" # cnctsun multiplayer only setup
  TRICKS: "dotnet20"
  NO_AT_BRIDGE: 1
  SOMMELIER_INSTALL_MONO: 1
  SOMMELIER_NO_THEME: 1
  SYSTEM_WGETRC: $SNAP/wine-runtime/etc/wgetrc

apps:
  cnctsun:
    extensions: [ gnome-3-28 ]
    command: |
      bin/sommelier run-exe
    environment:
      RUN_EXE: "$WINEPREFIX/drive_c/Games/CnCNet/TiberianSun_Online/TSMPLauncher.exe"
      RUN_EXE_2: "$WINEPREFIX/drive_c/Westwood/SUN/Launcher.exe"
    plugs:
      - home
      - network
      - network-bind
      - opengl
      - audio-playback

  wine:
    extensions: [ gnome-3-28 ]
    command: bin/sommelier
    plugs:
      - home
      - network

  winetricks:
    extensions: [ gnome-3-28 ]
    command: bin/sommelier winetricks
    plugs:
      - network

parts:
  cnctsun:
    plugin: nil
    source: ./snap/local/src
    override-build: |
      snapcraftctl build
      set -ex
      mkdir -p sommelier/hooks ; mv pre-install sommelier/hooks ; cp -R -p sommelier $SNAPCRAFT_PART_INSTALL
    stage:
      - sommelier

  # The sommelier script helps you snap Windows applications using Wine. It
  # initializes and configures Wine and installs the Windows application.
  sommelier:
    plugin: make
    source: https://github.com/mmtrt/sommelier-core.git
    source-branch: "multi-exe-patch"
